<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>China Soybean Imports</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
</head>
<body>
    <div id="main" style="width: 100%;height:600px;"></div>
    <script type="text/javascript">
        var myChart = echarts.init(document.getElementById('main'));

        const jsonUrl = '../data/processed/Q1.1.soybean_imports_quantity_price.json';
        fetch(jsonUrl).then(function(resp){return resp.json();}).then(function(data){
        var startDate = new Date('2024-01-01');
        var filtered = data.filter(function(item){
            var s = item.refMonth;
            var dt = new Date((typeof s === 'string' && s.length === 7) ? (s + '-01') : s);
            return dt >= startDate;
        });

        const months = filtered.map(function(item){return item.refMonth;});
        const argentinaData = filtered.map(function(item){return item.Argentina;});
        const brazilData = filtered.map(function(item){return item.Brazil;});
        const usaData = filtered.map(function(item){return item.USA;});

        const totalQuantities = filtered.map(function(item){return item.Argentina + item.Brazil + item.USA;});
        const totalCif = filtered.map(function(item){return item.Argentina_cif + item.Brazil_cif + item.USA_cif;});

        const unitPrice = totalCif.map(function(cif, i){return totalQuantities[i] > 0 ? (cif / totalQuantities[i]) * 1000 : 0;});
        const argentinaUnitPrice = filtered.map(function(item){return item.Argentina > 0 ? (item.Argentina_cif / item.Argentina) * 1000 : null;});
        const brazilUnitPrice = filtered.map(function(item){return item.Brazil > 0 ? (item.Brazil_cif / item.Brazil) * 1000 : null;});
        const usaUnitPrice = filtered.map(function(item){return item.USA > 0 ? (item.USA_cif / item.USA) * 1000 : null;});
        // const weightedAvgUnitPrice = data.map(item => {
        //     const tc = item.Argentina_cif + item.Brazil_cif + item.USA_cif;
        //     if (tc > 0) {
        //         const pA = item.Argentina > 0 ? (item.Argentina_cif / item.Argentina) * 1000 : 0;
        //         const pB = item.Brazil > 0 ? (item.Brazil_cif / item.Brazil) * 1000 : 0;
        //         const pU = item.USA > 0 ? (item.USA_cif / item.USA) * 1000 : 0;
        //         return (pA * item.Argentina_cif + pB * item.Brazil_cif + pU * item.USA_cif) / tc;
        //     }
        //     return null;
        // });



        var option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross',
                    crossStyle: {
                        color: '#999'
                    }
                }
            },
            toolbox: {
                feature: {
                    dataView: {show: true, readOnly: false},
                    magicType: {show: true, type: ['line', 'bar']},
                    restore: {show: true},
                    saveAsImage: {show: true, name: 'Q1.1.china_soybean_imports_quantity_price_2024~2025'}
                }
            },
            legend: {
                // data: ['Argentina', 'Brazil', 'USA', 'Unit Price', 'Argentina Unit Price', 'Brazil Unit Price', 'USA Unit Price', 'Weighted Avg Unit Price']
                data: ['Argentina', 'Brazil', 'USA', 'Unit Price', 'Argentina Unit Price', 'Brazil Unit Price', 'USA Unit Price']
            },
            xAxis: [
                {
                    type: 'category',
                    data: months,
                    axisPointer: {
                        type: 'shadow'
                    }
                }
            ],
            yAxis: [
                {
                    type: 'value',
                    name: 'Import Quantity (kg)',
                    axisLabel: {
                        formatter: function (value) {
                            if (value >= 1000000000) {
                                return (value / 1000000000).toFixed(1) + 'B';
                            }
                            if (value >= 1000000) {
                                return (value / 1000000).toFixed(1) + 'M';
                            }
                            if (value >= 1000) {
                                return (value / 1000).toFixed(1) + 'K';
                            }
                            return value;
                        }
                    },
                    splitLine: { show: true, lineStyle: { type: 'solid' } }
                },
                {
                    type: 'value',
                    name: 'Unit Price (USD/ton)',
                    axisLabel: {
                        formatter: '${value}'
                    },
                    splitLine: { show: true, lineStyle: { type: 'dashed' } }
                }
            ],
            series: [
                {
                    name: 'Argentina',
                    type: 'bar',
                    stack: 'total',
                    label: {
                        show: false
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: argentinaData
                },
                {
                    name: 'Brazil',
                    type: 'bar',
                    stack: 'total',
                    label: {
                        show: false
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: brazilData
                },
                {
                    name: 'USA',
                    type: 'bar',
                    stack: 'total',
                    label: {
                        show: false
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: usaData
                },
                {
                    name: 'Unit Price',
                    type: 'line',
                    yAxisIndex: 1,
                    tooltip: {
                        valueFormatter: function (value) {
                            return '$' + value.toFixed(2) + ' / ton';
                        }
                    },
                    data: unitPrice
                },
                {
                    name: 'Argentina Unit Price',
                    type: 'line',
                    yAxisIndex: 1,
                    lineStyle: { color: '#73C0DE' },
                    tooltip: {
                        valueFormatter: function (value) {
                            return '$' + (value == null ? 0 : value.toFixed(2)) + ' / ton';
                        }
                    },
                    data: argentinaUnitPrice
                },
                {
                    name: 'Brazil Unit Price',
                    type: 'line',
                    yAxisIndex: 1,
                    lineStyle: { color: '#3BA272' },
                    tooltip: {
                        valueFormatter: function (value) {
                            return '$' + (value == null ? 0 : value.toFixed(2)) + ' / ton';
                        }
                    },
                    data: brazilUnitPrice
                },
                {
                    name: 'USA Unit Price',
                    type: 'line',
                    yAxisIndex: 1,
                    lineStyle: { color: '#FC8452' },
                    tooltip: {
                        valueFormatter: function (value) {
                            return '$' + (value == null ? 0 : value.toFixed(2)) + ' / ton';
                        }
                    },
                    data: usaUnitPrice
                },
                // {
                //     name: 'Weighted Avg Unit Price',
                //     type: 'line',
                //     yAxisIndex: 1,
                //     lineStyle: { color: '#c23531' },
                //     tooltip: {
                //         valueFormatter: function (value) {
                //             return '$' + (value == null ? 0 : value.toFixed(2)) + ' / ton';
                //         }
                //     },
                //     data: weightedAvgUnitPrice
                // }
            ]
        };

        myChart.setOption(option);
        }).catch(function(err){console.error(err);});
    </script>
</body>
</html>